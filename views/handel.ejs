<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>Registrer Handel</title>
  <link rel="stylesheet" href="/styles/index.css">
  <link rel="stylesheet" href="/styles/handel.css">
  <link rel="stylesheet" href="/styles/menyPanel.css">
</head>
<body>
  <%- include('partials/menyPanel') %>

  <main class="main-content">
    <h1>Registrer Handel</h1>

    <form id="handelForm">
      <label for="navn">Navn feks Apple:</label>
      <input type="text" id="navn" required>
      <button type="button" id="søkAksje">Søk</button>

      <div id="aksjeInfo" style="display: none;">
        <p><strong>Navn:</strong> <span id="aksjeNavn"></span></p>
        <p><strong>Pris:</strong> <span id="aksjePris"></span> USD</p>

        <label for="mengde">Mengde:</label>
        <input type="number" id="mengde" required>

        <label for="gebyr">Gebyr (DKK):</label>
        <input type="number" id="gebyr" required>

        <label for="handelType">Type:</label>
        <select id="handelType" required>
          <option value="kjøp">Kjøp</option>
          <option value="salg">Salg</option>
        </select>

        <button type="submit">Registrer</button>
      </div>
    </form>
  </main>

  <script>
    const portefoljeID = localStorage.getItem("aktivPortefoljeID");
    const brukernavn = localStorage.getItem("brukernavn");

    const søkAksjeBtn = document.getElementById("søkAksje");
    const aksjeInfo = document.getElementById("aksjeInfo");
    const aksjeNavn = document.getElementById("aksjeNavn");
    const aksjePris = document.getElementById("aksjePris");
    let aksjeData = null;

    søkAksjeBtn.addEventListener("click", () => {
      const navn = document.getElementById("navn").value.trim();

      if (!navn) return;

      fetch(`/api/aksje/${navn}`)
        .then(res => res.json())
        .then(data => {
          aksjeData = data;
          aksjeNavn.textContent = data.shortName;
          aksjePris.textContent = data.regularMarketPrice;
          aksjeInfo.style.display = "block";
        })
        .catch(err => {
          console.error(err);
          alert("Fant ikke aksjen. Sjekk navnet.");
        });
    });

    document.getElementById("handelForm").addEventListener("submit", (e) => {
      e.preventDefault();

      if (!brukernavn || !portefoljeID) {
        alert("Du må være logget inn og ha valgt en portefølje.");
        return;
      }

      const mengde = parseFloat(document.getElementById("mengde").value);
      const gebyr = parseFloat(document.getElementById("gebyr").value);
      const type = document.getElementById("handelType").value;
      const totalSum = aksjeData.regularMarketPrice * mengde;

      fetch('/transaksjon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          brukernavn,
          portefoljeID,
          ISIN: aksjeData.symbol,
          verditype: aksjeData.quoteType || 'aksje',
          verdiPapirPris: aksjeData.regularMarketPrice,
          mengde,
          totalSum,
          totalGebyr: gebyr,
          opprettelsedatoT: new Date().toISOString().split('T')[0],
          type
        })
      })
      .then(async res => {
        const data = await res.json();
        if (!res.ok) throw new Error(data.message);
        alert("Handel registrert!");
        window.location.href = '/enkeltportefolje';
      })
      .catch(err => {
        console.error(err);
        alert("Feil ved handel: " + err.message);
      });
    });
  </script>
</body>
</html>
